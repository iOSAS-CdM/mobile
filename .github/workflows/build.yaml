name: Expo React Native APK Build

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  android_build:
    runs-on: ubuntu-latest

    steps:
      # --- CHECKOUT REPO ---
      - name: üèó Checkout repository
        uses: actions/checkout@v4

      # --- SETUP ENVIRONMENT ---
      - name: üèó Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      # --- RESTORE NPM CACHE ---
      - name: ‚ö° Restore npm cache
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # --- INSTALL DEPENDENCIES ---
      - name: üì¶ Install Dependencies (with clean cache)
        run: |
          # Clean old caches to avoid corrupted tarballs
          rm -rf ~/.npm
          npm cache clean --force

          # Retry installation safely with legacy peer deps
          npm install --legacy-peer-deps || npm install --legacy-peer-deps --prefer-online

          # Fix missing dependency for react-native-tab-view
          npm install react-native-pager-view

      # --- SETUP JAVA + ANDROID ---
      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ‚úÖ Accept Android SDK licenses
        run: yes | sdkmanager --licenses

      # --- DECODE KEYSTORE ---
      - name: üîë Create Keystore File
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          mkdir -p android/app
          echo "$KEYSTORE_BASE64" | tr -d '\n' | base64 -d > android/app/upload-keystore.jks

      # --- CONFIGURE GRADLE SIGNING ---
      - name: ‚öôÔ∏è Setup Gradle Properties
        run: |
          echo "MYAPP_UPLOAD_STORE_FILE=upload-keystore.jks" >> android/gradle.properties
          echo "MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> android/gradle.properties
          echo "MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.STORE_PASSWORD }}" >> android/gradle.properties
          echo "MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> android/gradle.properties

      # --- PREBUILD + BUNDLE EXPO ASSETS ---
      - name: ‚ö° Prebuild Expo and Bundle Assets
        run: |
          if [ -f "app.json" ]; then
            echo "Running Expo prebuild/export..."
            npx expo prebuild --platform android
            npm install react-native-pager-view
            npx expo export --platform android
          else
            echo "No app.json found; assuming bare React Native project."
            mkdir -p android/app/src/main/assets
            npm install --no-save @react-native-community/cli
            npx react-native bundle \
              --platform android \
              --dev false \
              --entry-file index.js \
              --bundle-output android/app/src/main/assets/index.android.bundle \
              --assets-dest android/app/src/main/res
          fi

      # --- BUILD SIGNED APK ---
      - name: üöÄ Build release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease

      # --- UPLOAD ARTIFACT ---
      - name: ‚¨ÜÔ∏è Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk-${{ github.sha }}
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 7
